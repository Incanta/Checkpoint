services:
  nginx:
    container_name: nginx
    image: nginx
    depends_on:
      - filer
    restart: always
    volumes:
      - ./.data/nginx/logs:/var/log/nginx
      - ./.data/nginx/conf:/etc/nginx
    ports:
      - "80:80"
    command: "/bin/sh -c 'echo \"## DO NOT EDIT; THIS IS AUTOGENERATED. EDIT nginx.conf.dev-template INSTEAD\n\n$(envsubst < /etc/nginx/nginx.conf.dev-template)\" > /etc/nginx/nginx.conf; while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\"'"
    networks:
      - checkpoint
    environment:
      CHECKPOINT_HOSTNAME: "checkpoint.localhost"

  master:
    image: checkpointvcs/seaweedfs:local
    build:
      context: ./src/seaweedfs/docker
      dockerfile: Dockerfile.local
    pull_policy: never
    command: "master -ip=master -ip.bind=0.0.0.0"
    volumes:
      - ./.data/seaweed-config/security.toml:/etc/seaweedfs/security.toml
    networks:
      - checkpoint

  volume:
    image: checkpointvcs/seaweedfs:local
    build:
      context: ./src/seaweedfs/docker
      dockerfile: Dockerfile.local
    pull_policy: never
    command: 'volume -mserver="master:9333" -ip.bind=0.0.0.0 -port=8080'
    depends_on:
      - master
    volumes:
      - ./.data/seaweed-data:/data
      - ./.data/seaweed-config/security.toml:/etc/seaweedfs/security.toml
    networks:
      - checkpoint

  filer:
    image: checkpointvcs/seaweedfs:local
    build:
      context: ./src/seaweedfs/docker
      dockerfile: Dockerfile.local
    pull_policy: never
    command: 'filer -master="master:9333" -ip.bind=0.0.0.0 -metricsPort=9326'
    tty: true
    stdin_open: true
    depends_on:
      - master
      - volume
    volumes:
      - ./.data/seaweed-config/filer.toml:/etc/seaweedfs/filer.toml
      - ./.data/seaweed-config/security.toml:/etc/seaweedfs/security.toml
    networks:
      - checkpoint

  redis:
    image: redis
    ports:
      - 6379:6379
    volumes:
      - ./.data/redis:/data
    networks:
      - checkpoint

volumes:
  node_modules_redwood:
  node_modules_redwood_api:
  node_modules_redwood_web:
  node_modules_backend:

networks:
  checkpoint:
